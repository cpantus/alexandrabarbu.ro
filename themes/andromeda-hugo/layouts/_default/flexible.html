{{/* Flexible Layout Template - Sequential Section Rendering */}}
{{ define "main" }}

  {{/* Check for hero sections */}}
  {{ $hasHeroBreadcrumb := false }}
  {{ $hasOtherHero := false }}
  {{ range .Params.sections }}
    {{ if eq .type "hero-breadcrumb" }}
      {{ $hasHeroBreadcrumb = true }}
    {{ end }}
    {{/* Skip auto hero-breadcrumb if page has its own hero section */}}
    {{ if or (eq .type "hero-about") (eq .type "hero-home") (eq .type "hero-service") }}
      {{ $hasOtherHero = true }}
    {{ end }}
  {{ end }}

  {{/* Render page header - only if no other hero section exists */}}
  {{ if not $hasOtherHero }}
    {{ if $hasHeroBreadcrumb }}
      <!-- Page Header: hero-breadcrumb (from sections) -->
      {{ partial "sections/hero-breadcrumb.html" . }}
    {{ else }}
      <!-- Page Header: default (auto-generated) -->
      {{ partial "sections/hero-breadcrumb.html" . }}
    {{ end }}
  {{ end }}
  
  {{/* Process remaining sections in the EXACT order defined in front matter */}}
  {{ range $index, $section := .Params.sections }}
    {{ $sectionType := $section.type }}

    {{/* Skip hero-breadcrumb since it's already rendered above */}}
    {{ if ne $sectionType "hero-breadcrumb" }}
      {{/* Debug comment - visible in HTML source for troubleshooting */}}
      <!-- Section {{ add $index 1 }}: {{ $sectionType }} -->

      {{/* Dynamic Section Lookup with Intelligent Caching */}}
      {{ $sectionPartial := printf "sections/%s.html" $sectionType }}
      {{ $componentPartial := printf "components/%s.html" $sectionType }}

      {{/* Cache key strategy: section type + language + content hash (production only) */}}
      {{ $cacheKey := "" }}
      {{ if hugo.IsProduction }}
        {{ $contentHash := md5 (printf "%v%v" $sectionType $.Params) }}
        {{ $cacheKey = printf "%s-%s-%s" $sectionType $.Language $contentHash }}
      {{ end }}

      {{ if templates.Exists (printf "partials/%s" $sectionPartial) }}
        {{ if and hugo.IsProduction $cacheKey }}
          {{ partialCached $sectionPartial $ $cacheKey }}
        {{ else }}
          {{ partial $sectionPartial $ }}
        {{ end }}
      {{ else if templates.Exists (printf "partials/%s" $componentPartial) }}
        {{ if and hugo.IsProduction $cacheKey }}
          {{ partialCached $componentPartial $ $cacheKey }}
        {{ else }}
          {{ partial $componentPartial $ }}
        {{ end }}
      {{ else }}
        {{ warnf "Section not found: %s (tried sections/%s.html and components/%s.html) at %s" $sectionType $sectionType $sectionType $.File.Path }}
      {{ end }}
    {{ end }}

  {{ end }}
  
  {{/* Include pricing JavaScript if pricing section is used */}}
  {{ if in (printf "%v" .Params.sections) "pricing-tables" }}
    {{ partial "pricing-scripts.html" . }}
  {{ end }}
  
  {{/* Render page content after all sections */}}
  {{ if .Content }}
    <section class="section pt-0">
      <div class="container">
        <div class="row justify-content-center">
          <div class="col-lg-8">
            <div class="accordion faq-accordion" id="faqAccordion">
              {{ .Content }}
            </div>
          </div>
        </div>
      </div>
    </section>
  {{ end }}

  {{/* Global floating elements moved to baseof.html */}}

{{ end }}
