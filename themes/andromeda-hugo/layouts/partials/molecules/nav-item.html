{{/*
  Nav Item Molecule - Navigation link with dropdown and active state support

  BEM Structure: .c-nav-item

  Individual navigation link component with support for icons, badges, dropdowns,
  and automatic active state detection.

  Usage:
    {{ partial "molecules/nav-item.html" (dict
      "text" "Services"
      "url" "/services/"
      "active" true
      "context" .
    )}}

  Parameters:
    text (required) - Link text
    url (required) - Link URL
    context (required) - Current page context for active state detection
    active (optional) - Mark as active/current (default: auto-detect from context)
    icon (optional) - Icon name to display before/after text
    iconPosition (optional) - Icon position: left|right (default: left)
    badge (optional) - Badge text (e.g., "New", "3")
    badgeVariant (optional) - Badge color variant (default: primary)
    dropdown (optional) - Dropdown items array (converts to dropdown nav-item)
    class (optional) - Additional CSS classes
    target (optional) - Link target attribute (e.g., "_blank")
    rel (optional) - Link rel attribute (e.g., "noopener noreferrer")

  Dropdown Structure:
    dropdown: [
      { text: "Item 1", url: "/item1/" },
      { text: "Item 2", url: "/item2/", icon: "check" },
      { text: "divider", divider: true }
    ]

  Examples:
    Basic nav item:
      {{ partial "molecules/nav-item.html" (dict
        "text" "About"
        "url" "/about/"
        "context" .
      )}}

    With icon and badge:
      {{ partial "molecules/nav-item.html" (dict
        "text" "Notifications"
        "url" "/notifications/"
        "icon" "bell"
        "badge" "5"
        "badgeVariant" "error"
        "context" .
      )}}

    Dropdown nav item:
      {{ partial "molecules/nav-item.html" (dict
        "text" "Services"
        "url" "/services/"
        "dropdown" (slice
          (dict "text" "Therapy" "url" "/therapy/" "icon" "heart")
          (dict "text" "Coaching" "url" "/coaching/" "icon" "target")
          (dict "text" "divider" "divider" true)
          (dict "text" "All Services" "url" "/services/")
        )
        "context" .
      )}}

  Features:
    - BEM structure (.c-nav-item)
    - Auto active state detection (URL matching)
    - Icon atoms integration (before/after text)
    - Badge atoms integration (8 color variants)
    - Dropdown support (multi-level navigation)
    - External link handling (target="_blank", rel="noopener noreferrer")
    - Multilingual URL support (relLangURL)
    - WCAG AA accessible (keyboard nav, ARIA labels, focus indicators)
    - Responsive behavior (mobile/desktop specific styles)

  JavaScript:
    Requires vanilla-dropdown.js for dropdown functionality:
      data-toggle="dropdown"
      aria-expanded="false"

  SCSS:
    assets/scss/06-components/_nav-item.scss

  Backward Compatibility:
    Legacy Bootstrap classes mapped via @extend in SCSS:
      .nav-item → .c-nav-item
      .nav-link → .c-nav-item__link
      .dropdown → .c-nav-item--dropdown
      .dropdown-toggle → .c-nav-item__link--dropdown
      .dropdown-menu → .c-nav-item__dropdown
      .dropdown-item → .c-nav-item__dropdown-link
*/}}

{{/* Extract parameters */}}
{{ $text := .text }}
{{ $url := .url }}
{{ $context := .context | default . }}
{{ $active := .active }}
{{ $icon := .icon }}
{{ $iconPosition := .iconPosition | default "left" }}
{{ $badge := .badge }}
{{ $badgeVariant := .badgeVariant | default "primary" }}
{{ $dropdown := .dropdown }}
{{ $class := .class | default "" }}
{{ $target := .target }}
{{ $rel := .rel }}

{{/* Parameter validation */}}
{{ if not $text }}
  {{ errorf "Nav Item molecule requires 'text' parameter" }}
{{ end }}

{{ if not $url }}
  {{ errorf "Nav Item molecule requires 'url' parameter" }}
{{ end }}

{{/* Auto-detect active state if not explicitly set */}}
{{ if not (isset . "active") }}
  {{ $currentURL := $context.RelPermalink | default "" }}
  {{ if eq $currentURL $url }}
    {{ $active = true }}
  {{ else if and (ne $url "/") (hasPrefix $currentURL $url) }}
    {{ $active = true }}
  {{ end }}
{{ end }}

{{/* Build nav item classes */}}
{{ $navItemClass := "c-nav-item" }}
{{ if $dropdown }}
  {{ $navItemClass = printf "%s c-nav-item--dropdown" $navItemClass }}
{{ end }}
{{ if $active }}
  {{ $navItemClass = printf "%s c-nav-item--active" $navItemClass }}
{{ end }}
{{ if $class }}
  {{ $navItemClass = printf "%s %s" $navItemClass $class }}
{{ end }}

{{/* Build link classes */}}
{{ $linkClass := "c-nav-item__link" }}
{{ if $active }}
  {{ $linkClass = printf "%s c-nav-item__link--active" $linkClass }}
{{ end }}
{{ if $dropdown }}
  {{ $linkClass = printf "%s c-nav-item__link--dropdown" $linkClass }}
{{ end }}

{{/* Unique dropdown ID */}}
{{ $dropdownID := anchorize $text }}

{{/* Render navigation item */}}
<li class="{{ $navItemClass }}">
  {{ if $dropdown }}
    {{/* Dropdown nav item */}}
    <a
      class="{{ $linkClass }}"
      href="{{ $url | relLangURL }}"
      id="navDropdown{{ $dropdownID }}"
      role="button"
      data-toggle="dropdown"
      aria-expanded="false"
      {{ if $active }}aria-current="page"{{ end }}
    >
      {{/* Icon (left position) */}}
      {{ if and $icon (eq $iconPosition "left") }}
        <span class="c-nav-item__icon c-nav-item__icon--left">
          {{ partial "atoms/icon.html" (dict "name" $icon "size" "sm" "variant" "neutral") }}
        </span>
      {{ end }}

      {{/* Link text */}}
      <span class="c-nav-item__text">{{ $text }}</span>

      {{/* Icon (right position) */}}
      {{ if and $icon (eq $iconPosition "right") }}
        <span class="c-nav-item__icon c-nav-item__icon--right">
          {{ partial "atoms/icon.html" (dict "name" $icon "size" "sm" "variant" "neutral") }}
        </span>
      {{ end }}

      {{/* Badge */}}
      {{ with $badge }}
        <span class="c-nav-item__badge">
          {{ partial "atoms/tag.html" (dict "text" . "variant" $badgeVariant "size" "sm") }}
        </span>
      {{ end }}

      {{/* Dropdown chevron */}}
      <span class="c-nav-item__chevron">
        {{ partial "atoms/icon.html" (dict "name" "chevron-down" "size" "xs" "variant" "neutral") }}
      </span>
    </a>

    {{/* Dropdown menu */}}
    <ul class="c-nav-item__dropdown" aria-labelledby="navDropdown{{ $dropdownID }}">
      {{ range $dropdown }}
        {{ if .divider }}
          <li class="c-nav-item__divider"></li>
        {{ else }}
          <li>
            <a
              class="c-nav-item__dropdown-link"
              href="{{ .url | relLangURL }}"
              {{ with .target }}target="{{ . }}"{{ end }}
              {{ with .rel }}rel="{{ . }}"{{ end }}
            >
              {{/* Dropdown item icon */}}
              {{ if .icon }}
                <span class="c-nav-item__dropdown-icon">
                  {{ partial "atoms/icon.html" (dict "name" .icon "size" "sm" "variant" "neutral") }}
                </span>
              {{ end }}

              {{/* Dropdown item text */}}
              <span class="c-nav-item__dropdown-text">{{ .text }}</span>

              {{/* Dropdown item badge */}}
              {{ with .badge }}
                <span class="c-nav-item__dropdown-badge">
                  {{ partial "atoms/tag.html" (dict "text" . "variant" ($.badgeVariant | default "primary") "size" "xs") }}
                </span>
              {{ end }}
            </a>
          </li>
        {{ end }}
      {{ end }}
    </ul>

  {{ else }}
    {{/* Regular nav item */}}
    <a
      class="{{ $linkClass }}"
      href="{{ $url | relLangURL }}"
      {{ with $target }}target="{{ . }}"{{ end }}
      {{ with $rel }}rel="{{ . }}"{{ end }}
      {{ if $active }}aria-current="page"{{ end }}
    >
      {{/* Icon (left position) */}}
      {{ if and $icon (eq $iconPosition "left") }}
        <span class="c-nav-item__icon c-nav-item__icon--left">
          {{ partial "atoms/icon.html" (dict "name" $icon "size" "sm" "variant" "neutral") }}
        </span>
      {{ end }}

      {{/* Link text */}}
      <span class="c-nav-item__text">{{ $text }}</span>

      {{/* Icon (right position) */}}
      {{ if and $icon (eq $iconPosition "right") }}
        <span class="c-nav-item__icon c-nav-item__icon--right">
          {{ partial "atoms/icon.html" (dict "name" $icon "size" "sm" "variant" "neutral") }}
        </span>
      {{ end }}

      {{/* Badge */}}
      {{ with $badge }}
        <span class="c-nav-item__badge">
          {{ partial "atoms/tag.html" (dict "text" . "variant" $badgeVariant "size" "sm") }}
        </span>
      {{ end }}
    </a>
  {{ end }}
</li>
