{{/*
  Form Field Molecule - Enhanced form field with label, input, validation, and error handling

  Usage:
    {{ partial "molecules/form-field.html" (dict
      "type" "email"
      "name" "email"
      "id" "email"
      "label" "Email Address"
      "placeholder" "you@example.com"
      "required" true
      "variant" "primary"
    )}}

  Parameters:
    type (required) - Input type: text|email|tel|number|password|url|date|textarea|select|checkbox|radio
    name (required) - Input name attribute
    id (required) - Input ID attribute
    label (required) - Label text
    placeholder (optional) - Placeholder text
    value (optional) - Initial value
    required (optional) - Mark as required: true|false (default: false)
    disabled (optional) - Disable input: true|false (default: false)
    readonly (optional) - Make readonly: true|false (default: false)
    variant (optional) - Color variant: primary|secondary|tertiary|neutral (default: neutral)
    class (optional) - Additional CSS classes for wrapper
    inputClass (optional) - Additional CSS classes for input element
    labelClass (optional) - Additional CSS classes for label
    rows (optional) - Rows for textarea (default: 4)
    min (optional) - Min value for number inputs
    max (optional) - Max value for number inputs
    pattern (optional) - Validation pattern regex
    helpText (optional) - Help text displayed below input
    hint (optional) - Hint text displayed below label
    errorText (optional) - Error message for validation
    errorId (optional) - ID for error message (default: "{id}-error")
    showError (optional) - Show error initially: true|false (default: false)
    validationState (optional) - Validation state: valid|invalid
    floatingLabel (optional) - Use floating label: true|false (default: false)
    icon (optional) - Icon dict with name, position (left|right), size
    options (optional) - Options array for select (dict with value, text)
    attributes (optional) - Additional HTML attributes

  Examples:
    Basic text field:
      {{ partial "molecules/form-field.html" (dict
        "type" "text"
        "name" "fullname"
        "id" "fullname"
        "label" "Full Name"
        "required" true
      )}}

    Email with validation:
      {{ partial "molecules/form-field.html" (dict
        "type" "email"
        "name" "email"
        "id" "email"
        "label" "Email"
        "required" true
        "variant" "primary"
        "errorText" "Please enter a valid email address"
        "validationState" "invalid"
      )}}

    Field with icon:
      {{ partial "molecules/form-field.html" (dict
        "type" "text"
        "name" "search"
        "id" "search"
        "label" "Search"
        "icon" (dict "name" "search" "position" "left")
      )}}
*/}}

{{- $type := .type | default "text" -}}
{{- $name := .name -}}
{{- $id := .id -}}
{{- $label := .label -}}
{{- $placeholder := .placeholder -}}
{{- $value := .value -}}
{{- $required := .required | default false -}}
{{- $disabled := .disabled | default false -}}
{{- $readonly := .readonly | default false -}}
{{- $variant := .variant | default "neutral" -}}
{{- $class := .class | default "" -}}
{{- $inputClass := .inputClass | default "" -}}
{{- $labelClass := .labelClass | default "" -}}
{{- $rows := .rows | default 4 -}}
{{- $min := .min -}}
{{- $max := .max -}}
{{- $pattern := .pattern -}}
{{- $helpText := .helpText -}}
{{- $hint := .hint -}}
{{- $errorText := .errorText -}}
{{- $errorId := .errorId | default (printf "%s-error" $id) -}}
{{- $showError := .showError | default false -}}
{{- $validationState := .validationState -}}
{{- $floatingLabel := .floatingLabel | default false -}}
{{- $icon := .icon -}}
{{- $options := .options -}}
{{- $attributes := .attributes | default dict -}}

{{/* Determine if this is a checkable type */}}
{{- $isCheckable := or (eq $type "checkbox") (eq $type "radio") -}}

{{/* Build wrapper classes */}}
{{- $wrapperClass := "c-form__group" -}}
{{- $wrapperClass = printf "%s c-form__group--%s" $wrapperClass $variant -}}
{{- if $floatingLabel -}}
  {{- $wrapperClass = printf "%s c-form__group--floating" $wrapperClass -}}
{{- end -}}
{{- if $validationState -}}
  {{- $wrapperClass = printf "%s c-form__group--%s" $wrapperClass $validationState -}}
{{- end -}}
{{- if $class -}}
  {{- $wrapperClass = printf "%s %s" $wrapperClass $class -}}
{{- end -}}

{{/* Build label classes */}}
{{- $fullLabelClass := "c-form__label" -}}
{{- if $labelClass -}}
  {{- $fullLabelClass = printf "%s %s" $fullLabelClass $labelClass -}}
{{- end -}}

{{/* Build input classes */}}
{{- $fullInputClass := "" -}}
{{- if eq $type "textarea" -}}
  {{- $fullInputClass = "c-form__textarea" -}}
{{- else if eq $type "select" -}}
  {{- $fullInputClass = "c-form__select" -}}
{{- else if $isCheckable -}}
  {{- $fullInputClass = "c-form__check-input" -}}
{{- else -}}
  {{- $fullInputClass = "c-form__input" -}}
{{- end -}}
{{- if $inputClass -}}
  {{- $fullInputClass = printf "%s %s" $fullInputClass $inputClass -}}
{{- end -}}

{{/* Icon setup */}}
{{- $hasIcon := and $icon (isset $icon "name") -}}
{{- $iconPosition := "" -}}
{{- if $hasIcon -}}
  {{- $iconPosition = ($icon.position | default "left") -}}
{{- end -}}

<div class="{{ $wrapperClass }}">
  {{/* Label (above input for non-floating, non-checkable) */}}
  {{- if and $label (not $floatingLabel) (not $isCheckable) -}}
    <label class="{{ $fullLabelClass }}" for="{{ $id }}">
      {{- $label -}}
      {{- if $required -}}<span class="c-form__required">*</span>{{- end -}}
    </label>
    {{- with $hint -}}
      <small class="c-form__hint">{{ . }}</small>
    {{- end -}}
  {{- end -}}

  {{/* Input wrapper (with icon support) */}}
  {{- if $hasIcon -}}
    <div class="c-form__input-wrapper c-form__input-wrapper--icon-{{ $iconPosition }}">
      {{- if eq $iconPosition "left" -}}
        <span class="c-form__icon c-form__icon--left">
          {{ partial "atoms/icon.html" (dict "icon" $icon.name "size" ($icon.size | default "sm")) }}
        </span>
      {{- end -}}

      {{/* Input element */}}
      {{- if eq $type "textarea" -}}
        <textarea
          class="{{ $fullInputClass }}"
          id="{{ $id }}"
          name="{{ $name }}"
          placeholder="{{ $placeholder }}"
          rows="{{ $rows }}"
          {{- if $required }} required{{ end -}}
          {{- if $disabled }} disabled{{ end -}}
          {{- if $readonly }} readonly{{ end -}}
          {{- if $showError }} aria-invalid="true" aria-describedby="{{ $errorId }}"{{ end -}}
          {{- range $key, $val := $attributes }} {{ $key }}="{{ $val }}"{{ end -}}
        >{{ $value }}</textarea>
      {{- else if eq $type "select" -}}
        <select
          class="{{ $fullInputClass }}"
          id="{{ $id }}"
          name="{{ $name }}"
          {{- if $required }} required{{ end -}}
          {{- if $disabled }} disabled{{ end -}}
          {{- if $showError }} aria-invalid="true" aria-describedby="{{ $errorId }}"{{ end -}}
          {{- range $key, $val := $attributes }} {{ $key }}="{{ $val }}"{{ end -}}>
          {{- range $options -}}
            <option value="{{ .value }}"{{ if eq .value $value }} selected{{ end }}>{{ .text }}</option>
          {{- end -}}
        </select>
      {{- else -}}
        <input
          type="{{ $type }}"
          class="{{ $fullInputClass }}"
          id="{{ $id }}"
          name="{{ $name }}"
          {{- if $placeholder }} placeholder="{{ $placeholder }}"{{ end -}}
          {{- if $value }} value="{{ $value }}"{{ end -}}
          {{- if $required }} required{{ end -}}
          {{- if $disabled }} disabled{{ end -}}
          {{- if $readonly }} readonly{{ end -}}
          {{- if $min }} min="{{ $min }}"{{ end -}}
          {{- if $max }} max="{{ $max }}"{{ end -}}
          {{- if $pattern }} pattern="{{ $pattern }}"{{ end -}}
          {{- if $showError }} aria-invalid="true" aria-describedby="{{ $errorId }}"{{ end -}}
          {{- range $key, $val := $attributes }} {{ $key }}="{{ $val }}"{{ end -}}>
      {{- end -}}

      {{- if eq $iconPosition "right" -}}
        <span class="c-form__icon c-form__icon--right">
          {{ partial "atoms/icon.html" (dict "icon" $icon.name "size" ($icon.size | default "sm")) }}
        </span>
      {{- end -}}
    </div>
  {{- else -}}
    {{/* Input element (no icon wrapper) */}}
    {{- if eq $type "textarea" -}}
      <textarea
        class="{{ $fullInputClass }}"
        id="{{ $id }}"
        name="{{ $name }}"
        placeholder="{{ $placeholder | default (cond $floatingLabel $label "") }}"
        rows="{{ $rows }}"
        {{- if $required }} required{{ end -}}
        {{- if $disabled }} disabled{{ end -}}
        {{- if $readonly }} readonly{{ end -}}
        {{- if $showError }} aria-invalid="true" aria-describedby="{{ $errorId }}"{{ end -}}
        {{- range $key, $val := $attributes }} {{ $key }}="{{ $val }}"{{ end -}}
      >{{ $value }}</textarea>
    {{- else if eq $type "select" -}}
      <select
        class="{{ $fullInputClass }}"
        id="{{ $id }}"
        name="{{ $name }}"
        {{- if $required }} required{{ end -}}
        {{- if $disabled }} disabled{{ end -}}
        {{- if $showError }} aria-invalid="true" aria-describedby="{{ $errorId }}"{{ end -}}
        {{- range $key, $val := $attributes }} {{ $key }}="{{ $val }}"{{ end -}}>
        {{- range $options -}}
          <option value="{{ .value }}"{{ if eq .value $value }} selected{{ end }}>{{ .text }}</option>
        {{- end -}}
      </select>
    {{- else if $isCheckable -}}
      <div class="c-form__check">
        <input
          type="{{ $type }}"
          class="{{ $fullInputClass }}"
          id="{{ $id }}"
          name="{{ $name }}"
          {{- if $value }} value="{{ $value }}"{{ end -}}
          {{- if $required }} required{{ end -}}
          {{- if $disabled }} disabled{{ end -}}
          {{- if $readonly }} readonly{{ end -}}
          {{- if $showError }} aria-invalid="true" aria-describedby="{{ $errorId }}"{{ end -}}
          {{- range $key, $val := $attributes }} {{ $key }}="{{ $val }}"{{ end -}}>
        <label class="c-form__check-label" for="{{ $id }}">
          {{- $label -}}
          {{- if $required -}}<span class="c-form__required">*</span>{{- end -}}
        </label>
      </div>
    {{- else -}}
      <input
        type="{{ $type }}"
        class="{{ $fullInputClass }}"
        id="{{ $id }}"
        name="{{ $name }}"
        placeholder="{{ $placeholder | default (cond $floatingLabel $label "") }}"
        {{- if $value }} value="{{ $value }}"{{ end -}}
        {{- if $required }} required{{ end -}}
        {{- if $disabled }} disabled{{ end -}}
        {{- if $readonly }} readonly{{ end -}}
        {{- if $min }} min="{{ $min }}"{{ end -}}
        {{- if $max }} max="{{ $max }}"{{ end -}}
        {{- if $pattern }} pattern="{{ $pattern }}"{{ end -}}
        {{- if $showError }} aria-invalid="true" aria-describedby="{{ $errorId }}"{{ end -}}
        {{- range $key, $val := $attributes }} {{ $key }}="{{ $val }}"{{ end -}}>
    {{- end -}}
  {{- end -}}

  {{/* Label (after input for floating variant) */}}
  {{- if and $label $floatingLabel (not $isCheckable) -}}
    <label class="{{ $fullLabelClass }}" for="{{ $id }}">
      {{- $label -}}
      {{- if $required -}}<span class="c-form__required">*</span>{{- end -}}
    </label>
  {{- end -}}

  {{/* Help text */}}
  {{- with $helpText -}}
    <small class="c-form__help-text">{{ . }}</small>
  {{- end -}}

  {{/* Validation Icons (inside input for valid/invalid states) */}}
  {{- if eq $validationState "valid" -}}
    <span class="c-form__validation-icon c-form__validation-icon--success" aria-hidden="true">
      <i class="las la-check-circle"></i>
    </span>
  {{- else if eq $validationState "invalid" -}}
    <span class="c-form__validation-icon c-form__validation-icon--error" aria-hidden="true">
      <i class="las la-exclamation-circle"></i>
    </span>
  {{- end -}}

  {{/* Error message */}}
  {{- if $errorText -}}
    <div class="c-form__feedback c-form__feedback--invalid{{ if $showError }} c-form__feedback--visible{{ end }}" id="{{ $errorId }}" role="alert" aria-live="polite">
      <span class="c-form__feedback-text">{{ $errorText }}</span>
    </div>
  {{- end -}}
</div>
