{{/*
  Timeline Step Molecule - BEM refactored timeline/process step with icon/number, title, and description

  Usage:
    {{ partial "molecules/timeline-step.html" (dict
      "index" 0
      "icon" "calendar-check"
      "title" "Initial Consultation"
      "description" "We discuss your goals and create a treatment plan."
      "duration" "50 minutes"
    )}}

  Parameters:
    index (required) - Step index (0-based, used for numbering and layout calculations)
    title (required) - Step title text
    description (optional) - Step description text (supports markdown)
    icon (optional) - Icon name for icon atom (if not provided, shows step number)
    number (optional) - Custom number/label (overrides index-based numbering)
    duration (optional) - Duration/time text (e.g., "50 min", "2 weeks")
    variant (optional) - Color variant: primary|secondary|tertiary|neutral (default: "primary")
    layout (optional) - Layout type: standard|alternating|simple (default: "standard")
    class (optional) - Additional CSS classes
    highlights (optional) - Array of highlight items for bulleted list

  Layout Types:
    standard: Full timeline with left-aligned marker and card
    alternating: Alternates left/right alignment based on index (even/odd)
    simple: Simple numbered step without timeline connector (compact style)

  Color Variants:
    primary: Emerald gradient (default) - Main actions, trust
    secondary: Terracotta gradient - Warm, personal connection
    tertiary: Calm blue gradient - Informational content
    neutral: Gray gradient - Subtle, backgrounds

  Examples:
    Timeline step with icon and duration:
      {{ partial "molecules/timeline-step.html" (dict
        "index" 0
        "icon" "user-check"
        "title" "Assessment"
        "description" "Comprehensive psychological evaluation."
        "duration" "60 min"
        "variant" "primary"
        "layout" "standard"
      )}}

    Simple onboarding step:
      {{ partial "molecules/timeline-step.html" (dict
        "index" 0
        "number" "01"
        "title" "Sign Up"
        "description" "Create your account"
        "variant" "secondary"
        "layout" "simple"
      )}}

    Alternating timeline with highlights:
      {{ partial "molecules/timeline-step.html" (dict
        "index" 0
        "icon" "clipboard-check"
        "title" "Planning Session"
        "description" "We develop your personalized treatment plan."
        "highlights" (slice "Set goals" "Choose methods" "Schedule sessions")
        "duration" "45 min"
        "variant" "tertiary"
        "layout" "alternating"
      )}}

    Auto-numbered timeline loop:
      {{ range $index, $step := .steps }}
        {{ partial "molecules/timeline-step.html" (dict
          "index" $index
          "title" $step.title
          "description" $step.description
          "icon" $step.icon
          "duration" $step.duration
          "variant" $step.variant
        )}}
      {{ end }}

  BEM Structure:
    .c-timeline-step                     Block
    .c-timeline-step--primary            Modifier: color variant
    .c-timeline-step--simple             Modifier: layout type
    .c-timeline-step--align-right        Modifier: alternating alignment
    .c-timeline-step__marker             Element: icon/number wrapper
    .c-timeline-step__icon-wrapper       Element: icon circle container
    .c-timeline-step__number             Element: step number text
    .c-timeline-step__duration           Element: duration badge
    .c-timeline-step__content            Element: content card
    .c-timeline-step__highlights         Element: bulleted list
    .c-timeline-step__highlight-item     Element: highlight list item

  Version: 2.0.0 (BEM refactor, design token integration)
  Last Updated: 2025-11-20
*/}}

{{- /* ========================================
     PARAMETER EXTRACTION & VALIDATION
     ======================================== */ -}}
{{- $index := .index -}}
{{- $title := .title -}}
{{- $description := .description | default "" -}}
{{- $icon := .icon | default "" -}}
{{- $number := .number | default "" -}}
{{- $duration := .duration | default "" -}}
{{- $variant := .variant | default "primary" -}}
{{- $layout := .layout | default "standard" -}}
{{- $class := .class | default "" -}}
{{- $highlights := .highlights | default slice -}}

{{- /* Validate required parameters */ -}}
{{- if not (isset . "index") -}}
  {{- errorf "timeline-step.html: 'index' parameter is required (0-based step index)" -}}
{{- end -}}
{{- if not $title -}}
  {{- errorf "timeline-step.html: 'title' parameter is required (step title text)" -}}
{{- end -}}

{{- /* Validate variant (primary|secondary|tertiary|neutral) */ -}}
{{- $validVariants := slice "primary" "secondary" "tertiary" "neutral" -}}
{{- if not (in $validVariants $variant) -}}
  {{- warnf "timeline-step.html: invalid variant '%s'. Using 'primary'. Valid: %s" $variant (delimit $validVariants ", ") -}}
  {{- $variant = "primary" -}}
{{- end -}}

{{- /* Validate layout (standard|alternating|simple) */ -}}
{{- $validLayouts := slice "standard" "alternating" "simple" -}}
{{- if not (in $validLayouts $layout) -}}
  {{- warnf "timeline-step.html: invalid layout '%s'. Using 'standard'. Valid: %s" $layout (delimit $validLayouts ", ") -}}
  {{- $layout = "standard" -}}
{{- end -}}

{{- /* ========================================
     STEP NUMBER CALCULATION
     ======================================== */ -}}
{{- $stepNumber := add $index 1 -}}
{{- if $number -}}
  {{- $stepNumber = $number -}}
{{- end -}}

{{- /* ========================================
     LAYOUT ALIGNMENT (for alternating)
     ======================================== */ -}}
{{- $isRightAligned := false -}}
{{- if eq $layout "alternating" -}}
  {{- $isRightAligned = modBool $index 2 -}}
{{- end -}}

{{- /* ========================================
     BEM CLASS CONSTRUCTION
     ======================================== */ -}}
{{- $blockClass := "c-timeline-step" -}}
{{- $modifiers := slice -}}
{{- $modifiers = $modifiers | append (printf "c-timeline-step--%s" $variant) -}}
{{- if eq $layout "simple" -}}
  {{- $modifiers = $modifiers | append "c-timeline-step--simple" -}}
{{- end -}}
{{- if $isRightAligned -}}
  {{- $modifiers = $modifiers | append "c-timeline-step--align-right" -}}
{{- end -}}
{{- $allClasses := delimit (append (slice $blockClass) $modifiers) " " -}}
{{- if $class -}}
  {{- $allClasses = printf "%s %s" $allClasses $class -}}
{{- end -}}

{{- /* ========================================
     SIMPLE LAYOUT VARIANT
     ======================================== */ -}}
{{- if eq $layout "simple" -}}
  <div class="{{ $allClasses }}">
    {{- /* Icon/Number Wrapper */ -}}
    <div class="c-timeline-step__marker c-timeline-step__marker--center">
      <div class="c-timeline-step__icon-wrapper">
        {{- if $icon -}}
          {{- /* Use icon atom with variant parameter */ -}}
          {{ partial "atoms/icon.html" (dict
            "name" $icon
            "size" "lg"
            "variant" $variant
          ) }}
        {{- else -}}
          <span class="c-timeline-step__number">{{ $stepNumber }}</span>
        {{- end -}}
      </div>
    </div>

    {{- /* Content */ -}}
    <div class="c-timeline-step__content c-timeline-step__content--center">
      {{- if $title -}}
        {{ partial "atoms/heading.html" (dict
          "text" $title
          "level" 5
          "variant" $variant
          "class" "c-timeline-step__title"
        ) }}
      {{- end -}}

      {{- if $description -}}
        <p class="c-timeline-step__description">{{ $description | markdownify }}</p>
      {{- end -}}
    </div>
  </div>

{{- /* ========================================
     STANDARD / ALTERNATING LAYOUT VARIANT
     ======================================== */ -}}
{{- else -}}
  <div class="{{ $allClasses }}">
    {{- /* Timeline Marker (icon circle + optional duration) */ -}}
    <div class="c-timeline-step__marker">
      <div class="c-timeline-step__icon-wrapper">
        {{- if $icon -}}
          {{- /* Use icon atom with glass wrapper */ -}}
          {{ partial "atoms/icon.html" (dict
            "name" $icon
            "size" "lg"
            "variant" $variant
            "wrapper" "glass"
          ) }}
        {{- else -}}
          <span class="c-timeline-step__number">{{ $stepNumber }}</span>
        {{- end -}}
      </div>

      {{- if $duration -}}
        <div class="c-timeline-step__duration">
          {{ partial "atoms/icon.html" (dict
            "name" "clock"
            "size" "sm"
            "class" "c-timeline-step__duration-icon"
          ) }}
          <span class="c-timeline-step__duration-text">{{ $duration }}</span>
        </div>
      {{- end -}}
    </div>

    {{- /* Timeline Content Card */ -}}
    <div class="c-timeline-step__content">
      {{- if $title -}}
        {{ partial "atoms/heading.html" (dict
          "text" $title
          "level" 4
          "variant" $variant
          "class" "c-timeline-step__title"
        ) }}
      {{- end -}}

      {{- if $description -}}
        <p class="c-timeline-step__description">{{ $description | markdownify }}</p>
      {{- end -}}

      {{- /* Highlights (bulleted list) */ -}}
      {{- if $highlights -}}
        <ul class="c-timeline-step__highlights">
          {{- range $highlights -}}
            <li class="c-timeline-step__highlight-item">
              {{ partial "atoms/icon.html" (dict
                "name" "check-circle"
                "size" "sm"
                "variant" $variant
                "class" "c-timeline-step__highlight-icon"
              ) }}
              <span class="c-timeline-step__highlight-text">{{ . }}</span>
            </li>
          {{- end -}}
        </ul>
      {{- end -}}
    </div>
  </div>
{{- end -}}
