{{/*
  Language Selector Molecule (BEM Refactor v3.0)

  Displays language switcher for multilingual sites with flags and localStorage persistence.
  Supports desktop/mobile display modes and 4 semantic color variants.

  BEM Structure:
    .c-language-selector                 â†’ Container
    .c-language-selector--mobile         â†’ Mobile variant modifier
    .c-language-selector--desktop        â†’ Desktop variant modifier
    .c-language-selector--primary        â†’ Primary color variant
    .c-language-selector--secondary      â†’ Secondary color variant
    .c-language-selector--tertiary       â†’ Tertiary color variant
    .c-language-selector--neutral        â†’ Neutral color variant
    .c-language-selector__select         â†’ Select element
    .c-language-selector__option         â†’ Option element

  Usage:
    Desktop (primary):
      {{ partial "molecules/language-selector.html" (dict "variant" "desktop" "color" "primary" "context" .) }}

    Mobile (secondary):
      {{ partial "molecules/language-selector.html" (dict "variant" "mobile" "color" "secondary" "context" .) }}

    Navbar:
      {{ partial "molecules/language-selector.html" (dict "variant" "desktop" "color" "neutral" "context" .) }}

  Parameters:
    - variant (string, optional): "desktop" or "mobile" (default: "desktop")
    - color (string, optional): "primary", "secondary", "tertiary", "neutral" (default: "primary")
    - context (context, required): Page context for translations
    - autoRedirect (bool, optional): Enable homepage auto-redirect (default: true)

  Features:
    - ğŸ¨ 4 semantic color variants for flexible theming
    - ğŸŒ Flag emoji icons for visual language identification
    - ğŸ’¾ localStorage persistence for user preference
    - â™¿ ARIA labels for accessibility
    - ğŸ”„ Optional auto-redirect to preferred language on homepage
    - ğŸ“± Responsive mobile/desktop variants
    - ğŸ¯ BEM class structure for maintainability
    - ğŸŒ Fallback for missing flag emojis

  JavaScript Integration:
    - Requires: assets/js/language-selector.js
    - Functions: window.languageSelector.switch(url)
    - Events: languageChanged (custom event)

  Design Tokens:
    - Typography: Crimson Pro (language names)
    - Spacing: 8pt grid
    - Colors: 4 semantic variants
    - Transitions: 250ms ease-out

  Accessibility:
    - ARIA labels for screen readers
    - Keyboard navigation support
    - High contrast mode support
    - Focus indicators
*/}}

{{- $variant := .variant | default "desktop" -}}
{{- $color := .color | default "primary" -}}
{{- $context := .context | default . -}}
{{- $autoRedirect := .autoRedirect | default true -}}

{{/* Validation */}}
{{- if not $context -}}
  {{- errorf "language-selector.html: Missing required 'context' parameter" -}}
{{- end -}}

{{- if not (in (slice "desktop" "mobile") $variant) -}}
  {{- warnf "language-selector.html: Invalid variant '%s', using 'desktop'. Valid: desktop, mobile" $variant -}}
  {{- $variant = "desktop" -}}
{{- end -}}

{{- if not (in (slice "primary" "secondary" "tertiary" "neutral") $color) -}}
  {{- warnf "language-selector.html: Invalid color '%s', using 'primary'. Valid: primary, secondary, tertiary, neutral" $color -}}
  {{- $color = "primary" -}}
{{- end -}}

{{/* Language flag mapping - easily extensible */}}
{{- $languageFlags := dict
  "ro" "ğŸ‡·ğŸ‡´"
  "en" "ğŸ‡¬ğŸ‡§"
  "fr" "ğŸ‡«ğŸ‡·"
  "de" "ğŸ‡©ğŸ‡ª"
  "es" "ğŸ‡ªğŸ‡¸"
  "it" "ğŸ‡®ğŸ‡¹"
-}}

{{/* Check if site has multiple languages */}}
{{- if gt (len site.Languages) 1 -}}
  {{/* Generate unique ID for mobile/desktop instances */}}
  {{- $uniqueID := printf "language-selector-%s-%s" $variant (replace $color " " "-") -}}

  <div class="c-language-selector c-language-selector--{{ $variant }} c-language-selector--{{ $color }}">
    <select
      class="c-language-selector__select"
      id="{{ $uniqueID }}"
      data-auto-redirect="{{ $autoRedirect }}"
      aria-label="{{ i18n `select_language` | default `Select Language` }}">

      {{- $pageLang := $context.Lang -}}

      {{/* Loop through all configured languages */}}
      {{- range site.Languages -}}
        {{- $langCode := .Lang -}}
        {{- $flag := index $languageFlags $langCode | default "ğŸŒ" -}}
        {{- $langName := .LanguageName | default $langCode -}}
        {{- $isCurrentLang := eq $langCode $pageLang -}}

        {{/* Get the URL for this language version of the page */}}
        {{- $langURL := "" -}}
        {{- if $isCurrentLang -}}
          {{- $langURL = $context.RelPermalink -}}
        {{- else -}}
          {{/* Try to find translation */}}
          {{- range $context.Translations -}}
            {{- if eq .Lang $langCode -}}
              {{- $langURL = .RelPermalink -}}
            {{- end -}}
          {{- end -}}
          {{/* Fallback to homepage if no translation exists */}}
          {{- if not $langURL -}}
            {{- $langURL = printf "/%s/" $langCode | absLangURL -}}
          {{- end -}}
        {{- end -}}

        <option
          value="{{ $langURL }}"
          data-lang="{{ $langCode }}"
          class="c-language-selector__option"
          {{- if $isCurrentLang }} selected{{- end -}}>
          {{ $flag }} {{ $langName }}
        </option>
      {{- end -}}
    </select>
  </div>
{{- end -}}
