{{/*
  Video Embed Molecule - Video player with thumbnail and play button (BEM structure)

  BEM Structure:
    .c-video                     - Block (wrapper)
    .c-video--16-9              - Modifier: 16:9 aspect ratio (default)
    .c-video--4-3               - Modifier: 4:3 aspect ratio
    .c-video--1-1               - Modifier: 1:1 aspect ratio (square)
    .c-video__wrapper           - Element: aspect ratio container
    .c-video__button            - Element: play button
    .c-video__thumbnail         - Element: video thumbnail image
    .c-video__placeholder       - Element: placeholder when no thumbnail
    .c-video__modal             - Element: hidden modal for playback
    .c-video__player            - Element: video player element

  Usage:
    {{ partial "molecules/video-embed.html" (dict
      "url" "https://www.youtube.com/watch?v=..."
      "thumbnail" "images/video-thumb.jpg"
      "title" "Watch Video"
    )}}

  Parameters:
    url (required) - Video URL (YouTube, Vimeo, or direct video link)
    thumbnail (optional) - Thumbnail image path (auto-generated for YouTube/Vimeo if not provided)
    title (optional) - Video title for accessibility (default: "Play Video")
    aspectRatio (optional) - Aspect ratio: 16-9|4-3|1-1 (default: "16-9")
    autoplay (optional) - Autoplay video (default: false)
    controls (optional) - Show video controls (default: true)
    loop (optional) - Loop video (default: false)
    muted (optional) - Mute video (default: false)
    size (optional) - Thumbnail size for image processing (default: "700x")
    playIconSize (optional) - Play icon size (default: "xl")
    class (optional) - Additional CSS classes for wrapper

  Examples:
    YouTube video (auto thumbnail):
      {{ partial "molecules/video-embed.html" (dict
        "url" "https://www.youtube.com/watch?v=dQw4w9WgXcQ"
        "title" "Rick Astley - Never Gonna Give You Up"
      )}}

    Vimeo video with custom thumbnail:
      {{ partial "molecules/video-embed.html" (dict
        "url" "https://vimeo.com/123456789"
        "thumbnail" "images/demo-thumb.jpg"
        "aspectRatio" "4-3"
      )}}

    Direct video with square aspect:
      {{ partial "molecules/video-embed.html" (dict
        "url" "/videos/intro.mp4"
        "thumbnail" "images/intro-thumb.jpg"
        "aspectRatio" "1-1"
        "autoplay" true
        "muted" true
      )}}

  Features:
    - BEM structure (.c-video__*)
    - 3 aspect ratio options (16:9, 4:3, 1:1)
    - YouTube/Vimeo/direct video support
    - Auto-generated YouTube thumbnails
    - Icon atom integration
    - Accessible (ARIA labels, keyboard support)
    - Responsive (mobile-first)
    - Design tokens (8pt spacing grid)
    - JavaScript integration for modal playback
    - Backward compatibility via SCSS @extend
*/}}

{{- $url := .url -}}
{{- $thumbnail := .thumbnail -}}
{{- $title := .title | default "Play Video" -}}
{{- $class := .class | default "" -}}
{{- $aspectRatio := .aspectRatio | default "16-9" -}}
{{- $autoplay := .autoplay | default false -}}
{{- $controls := .controls -}}
{{- if not (isset . "controls") -}}
  {{- $controls = true -}}
{{- end -}}
{{- $loop := .loop | default false -}}
{{- $muted := .muted | default false -}}
{{- $size := .size | default "700x" -}}
{{- $playIconSize := .playIconSize | default "xl" -}}

{{/* Parameter validation */}}
{{- if not $url -}}
  {{- errorf "Video Embed molecule requires 'url' parameter (file: %s)" .Page.File.Path -}}
{{- end -}}

{{- $validRatios := slice "16-9" "4-3" "1-1" -}}
{{- if not (in $validRatios $aspectRatio) -}}
  {{- warnf "Invalid aspectRatio '%s' for video embed. Using '16-9'. Valid: %s (file: %s)" $aspectRatio (delimit $validRatios ", ") .Page.File.Path -}}
  {{- $aspectRatio = "16-9" -}}
{{- end -}}

{{/* Detect video platform */}}
{{- $isYouTube := false -}}
{{- $isVimeo := false -}}
{{- if findRE "youtube\\.com|youtu\\.be" $url -}}
  {{- $isYouTube = true -}}
{{- else if findRE "vimeo\\.com" $url -}}
  {{- $isVimeo = true -}}
{{- end -}}

{{/* Build BEM classes */}}
{{- $blockClass := printf "c-video c-video--%s" $aspectRatio -}}
{{- if $class -}}
  {{- $blockClass = printf "%s %s" $blockClass $class -}}
{{- end -}}

<div class="{{ $blockClass }}">
  <div class="c-video__wrapper">
    {{/* Play button overlay */}}
    <button
      type="button"
      class="c-video__button"
      data-src="{{ $url }}"
      aria-label="{{ $title }}"
      title="{{ $title }}"
    >
      {{- partial "atoms/icon.html" (dict "name" "play" "size" $playIconSize "variant" "primary") -}}
    </button>

    {{/* Video thumbnail */}}
    {{- if $thumbnail -}}
      {{- partial "atoms/image.html" (dict
        "src" $thumbnail
        "alt" $title
        "class" "c-video__thumbnail"
        "size" $size
      ) -}}
    {{- else if $isYouTube -}}
      {{/* Auto-generate YouTube thumbnail */}}
      {{- $videoId := "" -}}
      {{- if findRE "youtube\\.com/watch\\?v=" $url -}}
        {{- $videoId = index (last 1 (split $url "v=")) 0 -}}
        {{- $videoId = index (split $videoId "&") 0 -}}
      {{- else if findRE "youtu\\.be/" $url -}}
        {{- $videoId = index (last 1 (split $url "/")) 0 -}}
        {{- $videoId = index (split $videoId "?") 0 -}}
      {{- end -}}
      {{- if $videoId -}}
        <img
          src="https://img.youtube.com/vi/{{ $videoId }}/maxresdefault.jpg"
          alt="{{ $title }}"
          class="c-video__thumbnail"
          loading="lazy"
        />
      {{- end -}}
    {{- else if $isVimeo -}}
      {{/* Vimeo requires API call for thumbnail, use placeholder */}}
      <div class="c-video__placeholder">
        {{- partial "atoms/icon.html" (dict "name" "video" "size" "2xl" "variant" "neutral") -}}
      </div>
    {{- else -}}
      {{/* Direct video or unknown - show placeholder */}}
      <div class="c-video__placeholder">
        {{- partial "atoms/icon.html" (dict "name" "video" "size" "2xl" "variant" "neutral") -}}
      </div>
    {{- end -}}

    {{/* Modal for video playback (JavaScript will handle this) */}}
    <div class="c-video__modal" style="display: none;">
      {{- if or $isYouTube $isVimeo -}}
        {{/* Embed code will be generated by JavaScript */}}
      {{- else -}}
        {{/* Direct video */}}
        <video
          class="c-video__player"
          {{ if $controls }}controls{{ end }}
          {{ if $autoplay }}autoplay{{ end }}
          {{ if $loop }}loop{{ end }}
          {{ if $muted }}muted{{ end }}
        >
          <source src="{{ $url | relURL }}" type="video/mp4">
          Your browser does not support the video tag.
        </video>
      {{- end -}}
    </div>
  </div>
</div>
