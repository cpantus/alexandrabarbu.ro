{{/*
  Image Atom - Responsive image with Hugo processing

  Usage:
    {{ partial "atoms/image.html" (dict
      "src" "images/hero.jpg"
      "alt" "Hero image"
      "width" 800
      "height" 600
      "class" "img-fluid"
      "lazy" true
      "webp" true
      "responsive" true
      "sizes" "(min-width: 768px) 800px, 100vw"
    )}}

  Parameters:
    src (required) - Image source path (relative to assets or static)
    alt (required) - Alt text for accessibility
    width (optional) - Target width in pixels (default: 800)
    height (optional) - Target height in pixels (default: auto)
    class (optional) - CSS classes (default: "img-fluid")
    lazy (optional) - Enable lazy loading (default: true)
    webp (optional) - Generate WebP format (default: true)
    responsive (optional) - Generate responsive srcset (default: true)
    sizes (optional) - Sizes attribute for responsive images
    quality (optional) - Image quality 1-100 (default: 90)
    fit (optional) - Resize method: resize|fill|fit (default: resize)
    objectFit (optional) - CSS object-fit: cover|contain|fill|none|scale-down (default: "")
    aspectRatio (optional) - CSS aspect-ratio: 1/1|4/3|16/9|21/9|custom (default: "")
    placeholder (optional) - Enable blur-up placeholder effect (default: false)
*/}}

{{ $src := .src }}
{{ $alt := .alt | default "Image" }}
{{ $width := .width | default 800 }}
{{ $height := .height }}
{{ $class := .class | default "img-fluid" }}
{{ $lazy := .lazy | default true }}
{{ $webp := .webp | default true }}
{{ $responsive := .responsive | default true }}
{{ $sizes := .sizes | default "(min-width: 768px) 800px, 100vw" }}
{{ $quality := .quality | default 90 }}
{{ $fit := .fit | default "resize" }}
{{ $objectFit := .objectFit | default "" }}
{{ $aspectRatio := .aspectRatio | default "" }}
{{ $placeholder := .placeholder | default false }}

{{/* Build inline styles for object-fit and aspect-ratio */}}
{{ $style := "" }}
{{ if $objectFit }}
  {{ $style = printf "object-fit: %s;" $objectFit }}
{{ end }}
{{ if $aspectRatio }}
  {{ $style = printf "%s aspect-ratio: %s;" $style $aspectRatio }}
{{ end }}

{{/* Try to load image from assets first, fallback to static */}}
{{ $image := "" }}
{{ $imageResource := false }}

{{/* Check if it's a page resource */}}
{{ with $.Page }}
  {{ $image = .Resources.GetMatch $src }}
  {{ if $image }}
    {{ $imageResource = true }}
  {{ end }}
{{ end }}

{{/* Try assets directory */}}
{{ if not $imageResource }}
  {{ $image = resources.Get $src }}
  {{ if $image }}
    {{ $imageResource = true }}
  {{ end }}
{{ end }}

{{/* If image is a resource, process it */}}
{{ if $imageResource }}

  {{/* Check if image is SVG - SVGs cannot be resized */}}
  {{ $isSVG := eq $image.MediaType.SubType "svg" }}

  {{/* Determine resize options */}}
  {{ $resizeSpec := printf "%dx%d q%d" $width (int $height) $quality }}
  {{ if not $height }}
    {{ $resizeSpec = printf "%dx q%d" $width $quality }}
  {{ end }}

  {{/* Process image based on fit method (skip for SVG) */}}
  {{ $processedImage := $image }}
  {{ if not $isSVG }}
    {{ if eq $fit "fill" }}
      {{ $processedImage = $image.Fill $resizeSpec }}
    {{ else if eq $fit "fit" }}
      {{ $processedImage = $image.Fit $resizeSpec }}
    {{ else }}
      {{ $processedImage = $image.Resize $resizeSpec }}
    {{ end }}
  {{ end }}

  {{/* Generate WebP and AVIF versions if requested (skip for SVG) */}}
  {{ $webpImage := "" }}
  {{ $avifImage := "" }}
  {{ if and $webp (not $isSVG) }}
    {{ $webpImage = $processedImage.Process (printf "webp q%d" $quality) }}
    {{ $avifImage = $processedImage.Process (printf "avif q%d" $quality) }}
  {{ end }}

  {{/* Generate blur-up placeholder if requested (skip for SVG) */}}
  {{ $placeholderImage := "" }}
  {{ if and $placeholder (not $isSVG) }}
    {{ $placeholderImage = $image.Resize "40x q20 GaussianBlur" }}
  {{ end }}

  {{/* Generate responsive srcset (skip for SVG) */}}
  {{ $srcset := "" }}
  {{ $srcsetWebp := "" }}
  {{ $srcsetAvif := "" }}
  {{ if and $responsive (not $isSVG) }}
    {{ $widths := slice (mul $width 0.5) $width (mul $width 1.5) (mul $width 2) }}
    {{ $srcsetParts := slice }}
    {{ $srcsetWebpParts := slice }}
    {{ $srcsetAvifParts := slice }}

    {{ range $widths }}
      {{ $w := int . }}
      {{ $resizeSpecResponsive := printf "%dx q%d" $w $quality }}
      {{ if $height }}
        {{ $h := int (mul $height (div (float $w) (float $width))) }}
        {{ $resizeSpecResponsive = printf "%dx%d q%d" $w $h $quality }}
      {{ end }}

      {{ $responsiveImg := $image.Resize $resizeSpecResponsive }}
      {{ $srcsetParts = $srcsetParts | append (printf "%s %dw" $responsiveImg.RelPermalink $w) }}

      {{ if $webp }}
        {{ $responsiveWebp := $responsiveImg.Process (printf "webp q%d" $quality) }}
        {{ $srcsetWebpParts = $srcsetWebpParts | append (printf "%s %dw" $responsiveWebp.RelPermalink $w) }}

        {{ $responsiveAvif := $responsiveImg.Process (printf "avif q%d" $quality) }}
        {{ $srcsetAvifParts = $srcsetAvifParts | append (printf "%s %dw" $responsiveAvif.RelPermalink $w) }}
      {{ end }}
    {{ end }}

    {{ $srcset = delimit $srcsetParts ", " }}
    {{ $srcsetWebp = delimit $srcsetWebpParts ", " }}
    {{ $srcsetAvif = delimit $srcsetAvifParts ", " }}
  {{ end }}

  {{/* Render picture element with WebP and fallback (or simple img for SVG) */}}
  {{ if $isSVG }}
    {{/* SVG: simple img element without width/height/srcset */}}
    <img
      src="{{ $image.RelPermalink }}"
      alt="{{ $alt }}"
      class="{{ $class }}"
      {{- if $lazy }} loading="lazy"{{ end }}>
  {{ else if and $webp $webpImage }}
    {{/* Raster with WebP/AVIF: picture element with modern formats */}}
    <picture>
      {{ if $responsive }}
        {{/* AVIF first (best compression, 76% browser support) */}}
        <source type="image/avif" srcset="{{ $srcsetAvif }}" sizes="{{ $sizes }}">
        {{/* WebP second (good compression, 96% browser support) */}}
        <source type="image/webp" srcset="{{ $srcsetWebp }}" sizes="{{ $sizes }}">
        {{/* Original format fallback (100% browser support) */}}
        <source type="{{ $processedImage.MediaType }}" srcset="{{ $srcset }}" sizes="{{ $sizes }}">
      {{ else }}
        <source type="image/avif" srcset="{{ $avifImage.RelPermalink }}">
        <source type="image/webp" srcset="{{ $webpImage.RelPermalink }}">
      {{ end }}
      <img
        src="{{ $processedImage.RelPermalink }}"
        alt="{{ $alt }}"
        class="{{ $class }}"
        width="{{ $processedImage.Width }}"
        height="{{ $processedImage.Height }}"
        {{- if $style }} style="{{ $style }}"{{ end }}
        {{- if $lazy }} loading="lazy"{{ end }}
        {{- if $responsive }} srcset="{{ $srcset }}" sizes="{{ $sizes }}"{{ end }}>
    </picture>
  {{ else }}
    {{/* Raster without WebP: standard img element */}}
    <img
      src="{{ $processedImage.RelPermalink }}"
      alt="{{ $alt }}"
      class="{{ $class }}"
      width="{{ $processedImage.Width }}"
      height="{{ $processedImage.Height }}"
      {{- if $style }} style="{{ $style }}"{{ end }}
      {{- if $lazy }} loading="lazy"{{ end }}
      {{- if and $responsive $srcset }} srcset="{{ $srcset }}" sizes="{{ $sizes }}"{{ end }}>
  {{ end }}

{{ else }}
  {{/* Fallback for static images (no processing) */}}
  <img
    src="{{ $src | relURL }}"
    alt="{{ $alt }}"
    class="{{ $class }}"
    {{- if $style }} style="{{ $style }}"{{ end }}
    {{- if $lazy }} loading="lazy"{{ end }}>
{{ end }}
