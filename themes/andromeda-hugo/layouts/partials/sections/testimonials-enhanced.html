{{/*
  Testimonials Enhanced Section - Client testimonials with ratings, verification, and outcomes

  Usage:
    sections:
      - type: "testimonials-enhanced"

    testimonials_enhanced:
      enable: true
      title: "What Clients Say"
      subtitle: "TESTIMONIALS"
      description: "Hear from people who've found healing and growth through therapy."
      variant: "primary"
      background: "light"
      testimonials:
        - quote: "Therapy helped me understand myself better."
          name: "A.M."
          age_range: "25-35"
          therapy_type: "Individual therapy"
          duration: "6 months"
          rating: 5
          verified: true
          outcome: "Reduced anxiety, improved relationships"
      privacy_note: "All testimonials are from real clients. Names are anonymized for privacy."
      cta_button:
        text: "Start Your Journey"
        url: "/contact"
        icon: "arrow-right"

  Parameters:
    enable (optional) - Enable/disable section (default: true)
    title (optional) - Section title
    subtitle (optional) - Section subtitle/eyebrow
    description (optional) - Section description
    variant (optional) - Color variant: primary|secondary|tertiary|neutral (default: "primary")
    background (optional) - Background color: light|white|primary-50 (default: "light")
    testimonials (required) - Array of testimonial objects:
      - quote (required) - Testimonial text
      - name (optional) - Client name/initials
      - age_range (optional) - Age range (e.g., "25-35")
      - therapy_type (optional) - Type of therapy
      - duration (optional) - Duration of therapy
      - rating (optional) - Star rating (1-5)
      - verified (optional) - Verified client badge
      - outcome (optional) - Therapy outcome/result
    privacy_note (optional) - Privacy disclaimer text
    cta_button (optional) - Call to action button

  BEM Structure:
    .c-testimonials              Block
    .c-testimonials--primary     Modifier: color variant
    .c-testimonials__header      Element: section header
    .c-testimonials__grid        Element: testimonials grid
    .c-testimonials__item        Element: single testimonial card
    .c-testimonials__rating      Element: star rating
    .c-testimonials__quote       Element: quote text
    .c-testimonials__author      Element: author details
    .c-testimonials__privacy     Element: privacy note
    .c-testimonials__cta         Element: CTA wrapper

  Version: 2.0.0 (BEM refactor)
  Last Updated: 2025-11-20
*/}}

{{- /* ========================================
     PARAMETER EXTRACTION & VALIDATION
     ======================================== */ -}}
{{- $section := .Params.testimonials_enhanced -}}
{{- if not $section -}}
  {{- return -}}
{{- end -}}

{{- $enable := $section.enable | default true -}}
{{- if not $enable -}}
  {{- return -}}
{{- end -}}

{{- $title := $section.title | default "" -}}
{{- $subtitle := $section.subtitle | default "" -}}
{{- $description := $section.description | default "" -}}
{{- $variant := $section.variant | default "primary" -}}
{{- $background := $section.background | default "light" -}}
{{- $testimonials := $section.testimonials | default slice -}}
{{- $privacyNote := $section.privacy_note | default "" -}}
{{- $ctaButton := $section.cta_button -}}

{{- /* Validate variant */ -}}
{{- $validVariants := slice "primary" "secondary" "tertiary" "neutral" -}}
{{- if not (in $validVariants $variant) -}}
  {{- warnf "testimonials-enhanced: invalid variant '%s'. Using 'primary'. Valid: %s" $variant (delimit $validVariants ", ") -}}
  {{- $variant = "primary" -}}
{{- end -}}

{{- /* ========================================
     SECTION ID & BEM CLASSES
     ======================================== */ -}}
{{- $blockClass := "c-testimonials" -}}
{{- $modifiers := slice (printf "c-testimonials--%s" $variant) -}}
{{- if $background -}}
  {{- $modifiers = $modifiers | append (printf "c-testimonials--bg-%s" $background) -}}
{{- end -}}
{{- $allClasses := delimit (append (slice $blockClass) $modifiers) " " -}}

{{- /* ========================================
     SECTION MARKUP
     ======================================== */ -}}
<section class="{{ $allClasses }}">
  <div class="o-container">

    {{- /* ========================================
         DECORATIVE QUOTE MARK (large background element)
         ======================================== */ -}}
    <div class="c-testimonials__decorative-quote" aria-hidden="true">
      <i class="las la-quote-left"></i>
    </div>

    {{- /* ========================================
         SECTION HEADER
         ======================================== */ -}}
    {{- if or $title $subtitle $description -}}
    <div class="c-testimonials__header">
      {{- if $subtitle -}}
        <p class="c-testimonials__subtitle">{{ $subtitle | markdownify }}</p>
      {{- end -}}

      {{- if $title -}}
        {{ partial "atoms/heading.html" (dict
          "text" $title
          "level" 2
          "variant" $variant
          "class" "c-testimonials__title"
        ) }}
      {{- end -}}

      {{- if $description -}}
        <p class="c-testimonials__description">{{ $description | markdownify }}</p>
      {{- end -}}
    </div>
    {{- end -}}

    {{- /* ========================================
         TESTIMONIALS GRID
         ======================================== */ -}}
    {{- if $testimonials -}}
    <div class="c-testimonials__grid">
      {{- range $index, $testimonial := $testimonials -}}
        {{- /* Color rotation for visual variety */ -}}
        {{- $colorVariants := slice "primary" "secondary" "coral" -}}
        {{- $colorIndex := mod $index (len $colorVariants) -}}
        {{- $itemVariant := index $colorVariants $colorIndex -}}

        <div class="c-testimonials__item c-testimonials__item--{{ $itemVariant }}" data-aos="fade-up" data-aos-delay="{{ mul $index 150 }}">
          {{- /* Floating Quote Mark */ -}}
          <div class="c-testimonials__floating-quote" aria-hidden="true">
            <i class="las la-quote-left"></i>
          </div>

          {{- /* Avatar Placeholder with Initials */ -}}
          {{- if $testimonial.name -}}
            {{- $initials := substr $testimonial.name 0 2 -}}
            <div class="c-testimonials__avatar c-testimonials__avatar--{{ $itemVariant }}">
              <span class="c-testimonials__initials">{{ $initials }}</span>
            </div>
          {{- end -}}

          {{- /* Star Rating */ -}}
          {{- if $testimonial.rating -}}
            <div class="c-testimonials__rating">
              {{- range seq $testimonial.rating -}}
                <i class="las la-star c-testimonials__star c-testimonials__star--filled"></i>
              {{- end -}}
              {{- if lt $testimonial.rating 5 -}}
                {{- range seq (sub 5 $testimonial.rating) -}}
                  <i class="las la-star c-testimonials__star c-testimonials__star--empty"></i>
                {{- end -}}
              {{- end -}}
            </div>
          {{- end -}}

          {{- /* Quote Text */ -}}
          {{- if $testimonial.quote -}}
            <blockquote class="c-testimonials__quote">
              <p>"{{ $testimonial.quote }}"</p>
            </blockquote>
          {{- end -}}

          {{- /* Author Info */ -}}
          <div class="c-testimonials__author">
            <div class="c-testimonials__author-details">
              {{- if $testimonial.name -}}
                <p class="c-testimonials__author-name">{{ $testimonial.name }}</p>
              {{- end -}}

              <div class="c-testimonials__author-meta">
                {{- if $testimonial.age_range -}}
                  <span class="c-testimonials__meta-item">{{ $testimonial.age_range }}</span>
                {{- end -}}
                {{- if $testimonial.therapy_type -}}
                  <span class="c-testimonials__meta-item">{{ $testimonial.therapy_type }}</span>
                {{- end -}}
                {{- if $testimonial.duration -}}
                  <span class="c-testimonials__meta-item">{{ $testimonial.duration }}</span>
                {{- end -}}
              </div>
            </div>

            {{- /* Verification Badge */ -}}
            {{- if $testimonial.verified -}}
              <div class="c-testimonials__verified" title="Verified client">
                <i class="las la-shield-check"></i>
              </div>
            {{- end -}}
          </div>

          {{- /* Outcome */ -}}
          {{- if $testimonial.outcome -}}
            <div class="c-testimonials__outcome">
              {{ partial "atoms/icon.html" (dict "name" "check-circle" "size" "sm" "variant" $itemVariant "class" "c-testimonials__outcome-icon") }}
              <span class="c-testimonials__outcome-text">{{ $testimonial.outcome }}</span>
            </div>
          {{- end -}}
        </div>
      {{- end -}}
    </div>
    {{- end -}}

    {{- /* ========================================
         PRIVACY NOTE (Card format with better styling)
         ======================================== */ -}}
    {{- if $privacyNote -}}
    <div class="c-testimonials__privacy">
      <i class="las la-lock c-testimonials__privacy-icon"></i>
      <span class="c-testimonials__privacy-text">{{ $privacyNote | markdownify }}</span>
    </div>
    {{- end -}}

    {{- /* ========================================
         CALL TO ACTION
         ======================================== */ -}}
    {{- if $ctaButton -}}
    <div class="c-testimonials__cta">
      {{ partial "atoms/button.html" (dict
        "text" $ctaButton.text
        "url" $ctaButton.url
        "variant" (default $variant $ctaButton.variant)
        "icon" $ctaButton.icon
      ) }}
    </div>
    {{- end -}}

  </div>
</section>
